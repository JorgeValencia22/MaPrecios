<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaPrecios | Business Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://www.paypal.com/sdk/js?client-id=BAAZ0X-3IhGgySgHkjA0ItlcqSu3fMmrTkQFmhcuPHWALq8CxO_jqGpa-4VTKlN1lQyp6c0eVNvCC7Novk&components=hosted-buttons&disable-funding=venmo&currency=USD"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAzNx7ARReSFqDt052rIficuErmuq10WMc",
        authDomain: "studio-2946557679-4235d.firebaseapp.com",
        projectId: "studio-2946557679-4235d",
        storageBucket: "studio-2946557679-4235d.firebasestorage.app",
        messagingSenderId: "1014571657099",
        appId: "1:1014571657099:web:f1bb8b8619c2474c95718e"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const ADMIN_EMAIL = "jorge.valencia.abarca@gmail.com";
      
      window.currentUser = null;
      window.isAdmin = false;
      window.myPos = null;

      window.onAuth = async (response) => {
          const payload = JSON.parse(atob(response.credential.split('.')[1]));
          const banSnap = await getDoc(doc(db, "blacklist", payload.email));
          if(banSnap.exists() && banSnap.data().until > Date.now()){
              alert("Cuenta suspendida."); return;
          }
          window.currentUser = payload;
          window.isAdmin = (payload.email === ADMIN_EMAIL);
          document.getElementById('auth-ui').classList.add('hidden');
          document.getElementById('post-ui').classList.remove('hidden');
          document.getElementById('promo-auth').classList.add('hidden');
          document.getElementById('promo-ui').classList.remove('hidden');
          if(window.isAdmin) document.getElementById('nav-admin').classList.remove('hidden');
          updateSelectors();
      };

      onSnapshot(collection(db, "negocios"), (snap) => { 
          window.allBusinesses = snap.docs.map(d => ({id: d.id, ...d.data()})); 
          updateSelectors(); 
          renderMarkers();
          checkPremiumProximity();
      });

      onSnapshot(query(collection(db, "productos"), orderBy("timestamp", "desc")), (snap) => { 
          window.allProducts = snap.docs.map(d => ({id: d.id, ...d.data()})); 
          renderList(); 
      });

      // L√≥gica de Pago y Activaci√≥n Premium
      window.initPayPal = () => {
          const bizId = document.getElementById('sel-promo-biz').value;
          if(!bizId) return alert("Selecciona un negocio primero");

          document.getElementById('paypal-container-4FUHMFXVCPNL8').innerHTML = "";
          paypal.HostedButtons({
            hostedButtonId: "4FUHMFXVCPNL8",
            onApprove: async (data, actions) => {
                await updateDoc(doc(db, "negocios", bizId), { premium: true, promoUntil: Date.now() + (30*24*60*60*1000) });
                alert("¬°Pago exitoso! Tu negocio ahora es Premium por 30 d√≠as.");
                location.reload();
            }
          }).render("#paypal-container-4FUHMFXVCPNL8");
      };

      // Verificar cercan√≠a a negocios Premium (Anuncios din√°micos)
      function checkPremiumProximity() {
          if(!window.myPos || !window.allBusinesses) return;
          window.allBusinesses.forEach(b => {
              if(b.premium && b.promoUntil > Date.now()){
                  const dist = map.distance(window.myPos, [b.lat, b.lng]);
                  if(dist < 2000) { // 2 Kil√≥metros
                      showLocalAd(b);
                  }
              }
          });
      }

      function showLocalAd(biz) {
          const ad = document.getElementById('premium-ad');
          if(ad.dataset.last === biz.id) return; // No repetir seguido
          ad.innerHTML = `
            <div class="ad-box">
                <small>TIENDA CERCANA DESTACADA</small>
                <h3>${biz.name}</h3>
                <p>¬°Vis√≠tanos! Estamos a pocos minutos de tu ubicaci√≥n.</p>
                <button class="btn" onclick="this.parentElement.parentElement.classList.add('hidden')">Ver en Mapa</button>
            </div>`;
          ad.dataset.last = biz.id;
          ad.classList.remove('hidden');
      }

      window.saveStore = async () => {
          const name = document.getElementById('store-name').value;
          const lat = document.getElementById('store-lat').value;
          const lng = document.getElementById('store-lng').value;
          await addDoc(collection(db, "negocios"), { 
              name, lat: parseFloat(lat), lng: parseFloat(lng), 
              creator: window.currentUser.email, premium: false 
          });
          document.getElementById('store-popup').classList.add('hidden');
      };

      window.go = (v, btn) => {
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.view').forEach(i => i.classList.add('hidden'));
          document.getElementById('v-'+v).classList.remove('hidden');
          if(v === 'map') setTimeout(() => map.invalidateSize(), 100);
          if(v === 'promo' && window.currentUser) updateSelectors();
      };

      window.updateSelectors = () => {
          const myBiz = window.allBusinesses?.filter(b => b.creator === window.currentUser?.email) || [];
          const opt = myBiz.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
          const allOpt = window.allBusinesses?.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
          
          if(document.getElementById('sel-promo-biz')) document.getElementById('sel-promo-biz').innerHTML = opt;
          if(document.getElementById('sel-biz')) document.getElementById('sel-biz').innerHTML = allOpt;
          if(document.getElementById('sel-prod')) document.getElementById('sel-prod').innerHTML = ["Arroz 1kg", "Aceite 900ml", "Leche 1L", "Pan 500g", "Bebida 2.5L"].map(p => `<option value="${p}">${p}</option>`).join('');
      };
    </script>

    <style>
        :root { --main: #0066ff; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); overflow: hidden; }
        
        #intro { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeOut 0.8s forwards 2.5s; }
        .logo-txt { font-size: 2.5rem; font-weight: 800; color: var(--main); }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        header { position: fixed; top: 0; width: 100%; height: 60px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
        .wrapper { height: 100vh; padding: 60px 0 80px 0; }
        .view { height: 100%; overflow-y: auto; padding: 20px; }

        /* Anuncio Premium */
        #premium-ad { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 2000; }
        .ad-box { background: #fff; padding: 20px; border-radius: 20px; border: 2px solid var(--main); box-shadow: 0 10px 30px rgba(0,102,255,0.2); text-align: center; }
        .ad-box small { color: var(--main); font-weight: 800; font-size: 10px; }

        /* PayPal Section */
        .promo-card { background: #fff; padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); text-align: center; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #e2e8f0; display: flex; height: 75px; }
        .nav-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #94a3b8; cursor: pointer; }
        .nav-item.active { color: var(--main); }

        .btn { background: var(--main); color: #fff; border: none; padding: 14px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 10px; }
        .hidden { display: none !important; }
        #map { width: 100%; height: 100%; border-radius: 20px; }
    </style>
</head>
<body>

<div id="intro"><div class="logo-txt">MaPrecios</div></div>
<div id="premium-ad" class="hidden"></div>

<header>
    <div style="font-weight: 800; color: var(--main);">MAPRECIOS</div>
    <div style="font-size: 10px; color: #64748b;">BUSINESS EDITION</div>
</header>

<div class="wrapper">
    <div id="v-list" class="view">
        <input type="text" id="find" placeholder="Buscar productos..." onkeyup="renderList()">
        <div id="product-list"></div>
    </div>

    <div id="v-map" class="view hidden" style="position:relative;">
        <div id="map"></div>
        <div id="store-popup" class="hidden" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:#fff; width:90%; padding:20px; border-radius:20px; z-index:1001;">
            <input type="text" id="store-name" placeholder="Nombre de la tienda">
            <input type="hidden" id="store-lat"><input type="hidden" id="store-lng">
            <button class="btn" onclick="saveStore()">Registrar Tienda</button>
        </div>
    </div>

    <div id="v-promo" class="view hidden">
        <div id="promo-auth" style="text-align:center; padding: 40px 0;">
            <h3>Impulsa tu Negocio</h3>
            <p>Inicia sesi√≥n para destacar tu tienda ante miles de usuarios cercanos.</p>
        </div>
        <div id="promo-ui" class="hidden">
            <div class="promo-card">
                <h4 style="margin-top:0">Publicidad Premium</h4>
                <p style="font-size:13px; color:#64748b;">Tu negocio aparecer√° como anuncio a todos los usuarios que pasen a menos de 2km por 30 d√≠as.</p>
                <label style="font-size:11px; font-weight:700;">1. SELECCIONA TU TIENDA</label>
                <select id="sel-promo-biz" onchange="initPayPal()"></select>
                <div id="paypal-container-4FUHMFXVCPNL8" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <div id="v-add" class="view hidden">
        <div id="auth-ui" style="text-align:center; padding: 40px 0;">
            <div id="g_id_onload" data-client_id="741318611947-h590d5p7s9njemslu7th8g38v09i210a.apps.googleusercontent.com" data-callback="onAuth"></div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
        <div id="post-ui" class="hidden">
            <select id="sel-biz"></select>
            <select id="sel-prod"></select>
            <input type="number" id="new-price" placeholder="Precio ($)">
            <button class="btn" onclick="savePrice()">Actualizar Precio</button>
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="go('list', this)">LISTA</div>
    <div class="nav-item" onclick="go('map', this)">MAPA</div>
    <div class="nav-item" onclick="go('add', this)">APORTAR</div>
    <div class="nav-item" onclick="go('promo', this)">PROMO üíé</div>
    <div id="nav-admin" class="nav-item hidden" onclick="go('admin', this)">ADMIN</div>
</div>

<script>
    let map = L.map('map', { zoomControl: false }).setView([-33.45, -70.66], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    navigator.geolocation.watchPosition(p => {
        window.myPos = [p.coords.latitude, p.coords.longitude];
        map.setView(window.myPos, 14);
        L.circleMarker(window.myPos, {radius: 6, color: '#0066ff'}).addTo(map);
    });

    map.on('click', (e) => {
        if(!window.currentUser) return alert("Inicia sesi√≥n");
        document.getElementById('store-popup').classList.remove('hidden');
        document.getElementById('store-lat').value = e.latlng.lat;
        document.getElementById('store-lng').value = e.latlng.lng;
    });

    window.renderList = () => {
        const q = document.getElementById('find').value.toLowerCase();
        let h = "";
        window.allProducts?.filter(p => p.product.toLowerCase().includes(q)).forEach(p => {
            h += `<div style="background:#fff; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #e2e8f0;">
                <div><b>${p.product}</b><br><small>${p.bizName}</small></div>
                <div style="color:#10b981; font-weight:800;">$${p.price}</div>
            </div>`;
        });
        document.getElementById('product-list').innerHTML = h;
    };

    window.renderMarkers = () => {
        window.allBusinesses?.forEach(b => {
            const color = b.premium ? 'gold' : 'blue';
            L.marker([b.lat, b.lng]).addTo(map).bindPopup(`<b>${b.name}</b> ${b.premium ? '‚≠ê' : ''}`);
        });
    };
</script>
</body>
</html>
