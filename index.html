<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaPrecios Business Pro | Kest Ecosystem</title>
    
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #0066ff;
            --dark: #0f172a;
            --accent: #f59e0b;
            --success: #10b981;
            --bg: #f8fafc;
            --glass: rgba(255, 255, 255, 0.9);
        }

        /* Reset Profesional */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--dark); overflow: hidden; height: 100vh; }

        /* Splash Screen Visionario */
        #kest-loader {
            position: fixed; inset: 0; background: #fff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease;
        }
        .k-box {
            width: 80px; height: 80px; background: var(--primary); border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 40px; font-weight: 800; animation: bounce 1s infinite;
        }

        /* Layout Principal */
        header {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: var(--glass); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }

        .view-container { height: 100vh; padding-top: 70px; padding-bottom: 80px; overflow-y: auto; }
        .view { padding: 20px; animation: fadeIn 0.4s ease; max-width: 600px; margin: 0 auto; }

        /* Componentes Business */
        .card {
            background: #fff; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 20px;
            border: 1px solid #f1f5f9;
        }

        .premium-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #fff; border: none; position: relative; overflow: hidden;
        }

        .premium-card::after {
            content: '⭐'; position: absolute; right: -10px; top: -10px;
            font-size: 80px; opacity: 0.1;
        }

        /* Botones de Acción */
        .btn-kest {
            background: var(--primary); color: white; border: none;
            width: 100%; padding: 16px; border-radius: 16px;
            font-weight: 700; font-size: 16px; cursor: pointer;
            transition: 0.3s; margin-top: 10px;
        }
        .btn-kest:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,102,255,0.2); }

        /* Inputs Modernos */
        .input-k {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1.5px solid #e2e8f0; margin: 10px 0; outline: none; transition: 0.3s;
        }
        .input-k:focus { border-color: var(--primary); background: #fff; }

        /* Navegación Inferior */
        nav {
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: var(--glass); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #e2e8f0; z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94a3b8; cursor: pointer; transition: 0.3s; font-size: 10px; font-weight: 700;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 4px; }

        /* Mapa */
        #map { width: 100%; height: 400px; border-radius: 24px; border: 4px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="kest-loader">
        <div class="k-box">K</div>
        <h2 style="margin-top:20px; font-weight: 800;">MaPrecios Pro</h2>
    </div>

    <header>
        <div style="font-weight: 800; font-size: 18px; letter-spacing: -0.5px;">KEST <span style="color: var(--primary);">BUSINESS</span></div>
        <div id="user-pill" class="hidden" style="background: #f1f5f9; padding: 5px 12px; border-radius: 100px; font-size: 12px; font-weight: 700;">
            <span id="user-display">Invitado</span>
        </div>
    </header>

    <div class="view-container">
        <div id="v-list" class="view">
            <div class="card" style="padding: 15px;">
                <input type="text" id="search-input" class="input-k" placeholder="Buscar productos en la red..." onkeyup="searchProducts()">
            </div>
            <div id="products-render"></div>
        </div>

        <div id="v-map" class="view hidden">
            <div id="map"></div>
            <p style="text-align:center; font-size:12px; color:#64748b; margin-top:15px;">Toca el mapa para registrar un nuevo punto de venta.</p>
        </div>

        <div id="v-add" class="view hidden">
            <div id="auth-zone" class="card" style="text-align: center;">
                <h3>Acceso de Colaborador</h3>
                <p style="font-size: 14px; color: #64748b; margin: 15px 0;">Identifícate para actualizar precios y ganar reputación en Kest.</p>
                <div id="google-btn-container" style="display: flex; justify-content: center;"></div>
            </div>

            <div id="post-zone" class="hidden">
                <div class="card">
                    <h4 style="margin-bottom:15px;">Registrar Precio</h4>
                    <select id="sel-biz" class="input-k"></select>
                    <select id="sel-prod" class="input-k">
                        <option>Arroz 1kg</option>
                        <option>Aceite 900ml</option>
                        <option>Leche 1L</option>
                        <option>Bebida 2.5L</option>
                        <option>Pan de Molde</option>
                    </select>
                    <input type="number" id="price-val" class="input-k" placeholder="Precio ($)">
                    <button class="btn-kest" onclick="publishPrice()">Publicar Ahora</button>
                </div>
            </div>
        </div>

        <div id="v-promo" class="view hidden">
            <div class="card premium-card">
                <h2>Impulso Premium</h2>
                <p style="font-size: 14px; margin: 10px 0 20px 0;">Haz que tu tienda sea la primera en aparecer cuando los clientes busquen ofertas.</p>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <ul style="font-size: 13px; list-style: none;">
                        <li>✅ Notificaciones a usuarios a 2km</li>
                        <li>✅ Distintivo dorado "Verificado"</li>
                        <li>✅ Prioridad en resultados</li>
                    </ul>
                </div>
                <select id="sel-promo-biz" class="input-k" style="background: #fff;"></select>
                <div id="paypal-container" style="margin-top: 15px;"></div>
                <button id="load-payment" class="btn-kest" style="background: var(--accent);" onclick="initPayments()">Activar Pasarela de Pago</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="go('list', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round"/></svg>
            LISTA
        </div>
        <div class="nav-item" onclick="go('map', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.6 16.6L13.4 20.9a2 2 0 01-2.8 0l-4.2-4.2a8 8 0 1111.3 0z" stroke-width="2" stroke-linecap="round"/></svg>
            MAPA
        </div>
        <div class="nav-item" onclick="go('add', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round"/></svg>
            APORTAR
        </div>
        <div class="nav-item" onclick="go('promo', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--accent)"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2" stroke-linecap="round"/></svg>
            PROMO
        </div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://accounts.google.com/gsi/client" async></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuración Firebase (Privada de MaPrecios)
        const firebaseConfig = {
            apiKey: "AIzaSyAzNx7ARReSFqDt052rIficuErmuq10WMc",
            authDomain: "studio-2946557679-4235d.firebaseapp.com",
            projectId: "studio-2946557679-4235d",
            storageBucket: "studio-2946557679-4235d.firebasestorage.app",
            messagingSenderId: "1014571657099",
            appId: "1:1014571657099:web:f1bb8b8619c2474c95718e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado Global
        window.user = null;
        window.db = db;
        window.allBiz = [];

        // Inicialización
        window.onload = () => {
            setTimeout(() => { document.getElementById('kest-loader').style.opacity = '0'; 
            setTimeout(() => document.getElementById('kest-loader').classList.add('hidden'), 600); }, 1500);
            initGoogleAuth();
            syncData();
        };

        // Google Auth - Versión Segura
        function initGoogleAuth() {
            google.accounts.id.initialize({
                client_id: "741318611947-h590d5p7s9njemslu7th8g38v09i210a.apps.googleusercontent.com",
                callback: handleAuth
            });
            google.accounts.id.renderButton(
                document.getElementById("google-btn-container"),
                { theme: "outline", size: "large", shape: "pill" }
            );
        }

        async function handleAuth(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            window.user = payload;
            
            document.getElementById('auth-zone').classList.add('hidden');
            document.getElementById('post-zone').classList.remove('hidden');
            document.getElementById('user-pill').classList.remove('hidden');
            document.getElementById('user-display').innerText = payload.given_name;
            updateSelectors();
        }

        // Sincronización Real-Time
        function syncData() {
            onSnapshot(collection(db, "negocios"), (snap) => {
                window.allBiz = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateSelectors();
                renderMarkers();
            });

            onSnapshot(query(collection(db, "productos"), orderBy("timestamp", "desc")), (snap) => {
                const prods = snap.docs.map(d => d.data());
                renderProducts(prods);
            });
        }

        // Navegación SPA
        window.go = (v, btn) => {
            document.querySelectorAll('.view').forEach(x => x.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById('v-'+v).classList.remove('hidden');
            btn.classList.add('active');
            if(v === 'map') setTimeout(() => map.invalidateSize(), 200);
        };

        // Lógica de Pagos (Evita bloqueos de seguridad)
        window.initPayments = () => {
            const bizId = document.getElementById('sel-promo-biz').value;
            if(!bizId) return alert("Selecciona un negocio de tu propiedad.");

            const script = document.createElement('script');
            script.src = "https://www.paypal.com/sdk/js?client-id=BAAZ0X-3IhGgySgHkjA0ItlcqSu3fMmrTkQFmhcuPHWALq8CxO_jqGpa-4VTKlN1lQyp6c0eVNvCC7Novk&components=hosted-buttons&disable-funding=venmo&currency=USD";
            script.onload = () => {
                document.getElementById('load-payment').classList.add('hidden');
                paypal.HostedButtons({
                    hostedButtonId: "4FUHMFXVCPNL8",
                    onApprove: async (data, actions) => {
                        await updateDoc(doc(db, "negocios", bizId), { 
                            premium: true, 
                            premiumUntil: Date.now() + (30*24*60*60*1000) 
                        });
                        alert("¡Visibilidad Premium Activada!");
                        location.reload();
                    }
                }).render("#paypal-container");
            };
            document.head.appendChild(script);
        };

        // Helpers de UI
        function updateSelectors() {
            const options = window.allBiz.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            document.getElementById('sel-biz').innerHTML = options;
            
            const myBiz = window.allBiz.filter(b => b.creator === window.user?.email);
            document.getElementById('sel-promo-biz').innerHTML = myBiz.map(b => `<option value="${b.id}">${b.name}</option>`).join('') || '<option disabled>No tienes tiendas registradas</option>';
        }

        window.publishPrice = async () => {
            const bizId = document.getElementById('sel-biz').value;
            const price = document.getElementById('price-val').value;
            const product = document.getElementById('sel-prod').value;
            
            if(!price) return;

            const biz = window.allBiz.find(b => b.id === bizId);
            await addDoc(collection(db, "productos"), {
                bizId, bizName: biz.name, product, price: parseFloat(price),
                timestamp: Date.now(), user: window.user.email, isPremium: biz.premium || false
            });
            alert("Precio actualizado en la red Kest.");
            document.getElementById('price-val').value = "";
        };

        function renderProducts(prods) {
            const container = document.getElementById('products-render');
            container.innerHTML = prods.map(p => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; border-left: 5px solid ${p.isPremium ? 'var(--accent)' : 'var(--primary)'}">
                    <div>
                        <div style="font-weight:800;">${p.product}</div>
                        <div style="font-size:12px; color:#64748b;">${p.bizName} ${p.isPremium ? '⭐' : ''}</div>
                    </div>
                    <div style="font-size:20px; font-weight:800; color:var(--success);">$${p.price}</div>
                </div>
            `).join('');
        }
    </script>

    <script>
        // Mapa e Interacciones
        let map = L.map('map', { zoomControl: false }).setView([-33.45, -70.66], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        map.on('click', async (e) => {
            if(!window.user) return alert("Inicia sesión para registrar una tienda.");
            const name = prompt("Nombre de la nueva tienda:");
            if(name) {
                await addDoc(collection(window.db, "negocios"), {
                    name, lat: e.latlng.lat, lng: e.latlng.lng,
                    creator: window.user.email, premium: false
                });
            }
        });

        function renderMarkers() {
            window.allBiz?.forEach(b => {
                L.marker([b.lat, b.lng]).addTo(map).bindPopup(`<b>${b.name}</b>`);
            });
        }
    </script>
</body>
</html>
