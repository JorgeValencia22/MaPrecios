<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaPrecios | Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAzNx7ARReSFqDt052rIficuErmuq10WMc",
        authDomain: "studio-2946557679-4235d.firebaseapp.com",
        projectId: "studio-2946557679-4235d",
        storageBucket: "studio-2946557679-4235d.firebasestorage.app",
        messagingSenderId: "1014571657099",
        appId: "1:1014571657099:web:f1bb8b8619c2474c95718e"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      
      window.currentUser = null;
      window.isAdmin = false;
      const ADMIN_EMAIL = "jorge.valencia.abarca@gmail.com";

      window.onAuth = (response) => {
          const payload = JSON.parse(atob(response.credential.split('.')[1]));
          window.currentUser = payload;
          window.isAdmin = (payload.email === ADMIN_EMAIL);
          document.getElementById('auth-card').style.display = 'none';
          document.getElementById('form-container').classList.remove('hidden');
          renderList(); 
      };

      onSnapshot(query(collection(db, "negocios")), (snap) => {
          window.allBusinesses = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
          updateSelectors();
          renderMarkers();
      });

      onSnapshot(query(collection(db, "productos"), orderBy("timestamp", "desc")), (snap) => {
          window.allProducts = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
          renderList();
      });

      window.saveStore = async () => {
          const name = document.getElementById('store-name').value;
          const lat = document.getElementById('store-lat').value;
          const lng = document.getElementById('store-lng').value;
          if(!name || !lat) return;
          await addDoc(collection(db, "negocios"), { name, lat: parseFloat(lat), lng: parseFloat(lng) });
          document.getElementById('store-name').value = "";
          document.getElementById('store-popup').classList.add('hidden');
      };

      window.savePrice = async () => {
          const price = document.getElementById('new-price').value;
          const bizId = document.getElementById('sel-biz').value;
          const product = document.getElementById('sel-prod').value;
          if(!price || !bizId) return;
          const b = window.allBusinesses.find(x => x.id === bizId);
          await addDoc(collection(db, "productos"), {
              bizName: b.name, product, price, userEmail: window.currentUser.email,
              timestamp: Date.now(), lat: b.lat, lng: b.lng
          });
          document.getElementById('new-price').value = "";
          alert("‚úì Precio actualizado");
      };

      window.deleteItem = async (col, id) => {
          if(window.isAdmin && confirm("¬øEliminar registro?")) await deleteDoc(doc(db, col, id));
      };
    </script>
    
    <style>
        :root { --main: #0066ff; --bg: #f8fafc; --card: #ffffff; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #1e293b; overflow: hidden; }
        
        /* Intro Profesional */
        #intro-screen {
            position: fixed; inset: 0; background: #fff; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeExit 0.8s forwards 3s;
        }
        .intro-logo {
            font-size: 2.5rem; font-weight: 800; color: var(--main);
            letter-spacing: -1px; opacity: 0; transform: translateY(20px);
            animation: logoFadeUp 1.2s forwards 0.5s;
        }
        .intro-sub {
            font-size: 0.9rem; color: #94a3b8; font-weight: 600; margin-top: 10px;
            opacity: 0; animation: fadeIn 1s forwards 1.5s;
        }
        @keyframes logoFadeUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes fadeExit { to { opacity: 0; visibility: hidden; } }

        /* Interfaz */
        header { 
            position: fixed; top: 0; width: 100%; height: 65px; background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px); border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; box-sizing: border-box;
        }
        .logo-small { font-weight: 800; font-size: 1.2rem; color: var(--main); }

        .container { height: 100vh; padding: 65px 0 85px 0; box-sizing: border-box; }
        .view { height: 100%; overflow-y: auto; padding: 20px; }

        .card { 
            background: var(--card); border-radius: 16px; padding: 18px; margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .price-tag { font-weight: 700; color: #10b981; font-size: 1.1rem; }

        #map { width: 100%; height: 100%; }
        
        /* Marcadores Pro */
        .dot-store { background: var(--main); border: 3px solid #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .dot-user { background: #10b981; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 15px rgba(16,185,129,0.4); }
        
        .btn-me { position: absolute; bottom: 100px; right: 20px; z-index: 500; background: #fff; border: none; width: 48px; height: 48px; border-radius: 12px; box-shadow: 0 8px 15px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #store-popup { position: absolute; bottom: 100px; left: 20px; right: 20px; background: #fff; padding: 22px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 1000; }

        nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; height: 68px; background: #fff; border-radius: 24px; box-shadow: 0 12px 24px rgba(0,0,0,0.06); display: flex; z-index: 1000; border: 1px solid #f1f5f9; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #94a3b8; cursor: pointer; }
        .nav-btn.active { color: var(--main); }

        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 12px; background: #f8fafc; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main); background: #fff; box-shadow: 0 0 0 3px rgba(0,102,255,0.1); }
        .btn-submit { background: var(--main); color: #fff; border: none; padding: 16px; width: 100%; border-radius: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .admin-del { color: #f43f5e; font-size: 10px; font-weight: 700; margin-top: 6px; display: block; text-decoration: none; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="intro-screen">
    <div class="intro-logo">MaPrecios</div>
    <div class="intro-sub">INTELIGENCIA COLABORATIVA</div>
</div>

<header>
    <div class="logo-small">MaPrecios</div>
    <div style="font-size: 10px; font-weight: 600; color: #64748b;">PRO SYSTEM</div>
</header>

<div class="container">
    <div id="tab-list" class="view">
        <input type="text" id="search" placeholder="Filtrar por nombre..." onkeyup="renderList()">
        <div id="items"></div>
    </div>

    <div id="tab-map" class="hidden" style="height:100%; position:relative;">
        <div id="map"></div>
        <button class="btn-me" onclick="toMe()">üìç</button>
        <div id="store-popup" class="hidden">
            <h4 style="margin:0 0 12px 0;">Registrar Nuevo Local</h4>
            <input type="text" id="store-name" placeholder="Nombre de la tienda">
            <input type="hidden" id="store-lat"><input type="hidden" id="store-lng">
            <button class="btn-submit" onclick="saveStore()">Guardar Local</button>
        </div>
    </div>

    <div id="tab-add" class="hidden view">
        <div id="auth-card" style="text-align: center; padding: 40px 20px;">
            <h3>Bienvenido</h3>
            <p style="color: #64748b; margin-bottom: 25px;">Inicia sesi√≥n para compartir precios.</p>
            <div id="g_id_onload" data-client_id="741318611947-h590d5p7s9njemslu7th8g38v09i210a.apps.googleusercontent.com" data-callback="onAuth"></div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
        <div id="form-container" class="hidden">
            <div style="background: #fff; padding: 24px; border-radius: 20px; border: 1px solid #f1f5f9;">
                <h4 style="margin-top:0;">Actualizar Precio</h4>
                <label style="font-size: 11px; font-weight: 700; color: #94a3b8;">SELECCIONAR LOCAL</label>
                <select id="sel-biz"></select>
                <label style="font-size: 11px; font-weight: 700; color: #94a3b8;">PRODUCTO</label>
                <select id="sel-prod"></select>
                <label style="font-size: 11px; font-weight: 700; color: #94a3b8;">PRECIO UNITARIO ($)</label>
                <input type="number" id="new-price" placeholder="00.00">
                <button class="btn-submit" onclick="savePrice()">Publicar Precio</button>
            </div>
        </div>
    </div>
</div>

<nav>
    <div class="nav-btn active" onclick="nav('list', this)">LISTA</div>
    <div class="nav-btn" onclick="nav('map', this)">MAPA</div>
    <div class="nav-btn" onclick="nav('add', this)">APORTAR</div>
</nav>

<script>
    const prods = ["Arroz 1kg", "Aceite 900ml", "Leche 1L", "Fideos 400g", "Az√∫car 1kg", "Papel Higi√©nico 4u", "Papas Fritas 180g", "Bebida 2.5L", "Caf√© 170g", "Detergente 3L"];
    
    let userP = null;
    let map = L.map('map', { zoomControl: false }).setView([-33.45, -70.66], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    const sIcon = L.divIcon({ className: 'dot-store', iconSize: [18, 18] });
    const uIcon = L.divIcon({ className: 'dot-user', iconSize: [12, 12] });

    navigator.geolocation.watchPosition(p => {
        userP = [p.coords.latitude, p.coords.longitude];
        if(window.uMk) window.uMk.setLatLng(userP);
        else window.uMk = L.marker(userP, {icon: uIcon}).addTo(map);
    }, null, { enableHighAccuracy: true });

    map.on('click', (e) => {
        if(!window.currentUser) return alert("Inicia sesi√≥n para agregar locales");
        document.getElementById('store-popup').classList.remove('hidden');
        document.getElementById('store-lat').value = e.latlng.lat;
        document.getElementById('store-lng').value = e.latlng.lng;
    });

    function toMe() { if(userP) map.flyTo(userP, 16); }

    function nav(v, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['tab-list','tab-map','tab-add'].forEach(i => document.getElementById(i).classList.add('hidden'));
        document.getElementById('tab-'+v).classList.remove('hidden');
        if(v === 'map') setTimeout(() => map.invalidateSize(), 150);
    }

    window.updateSelectors = () => {
        document.getElementById('sel-biz').innerHTML = window.allBusinesses?.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        document.getElementById('sel-prod').innerHTML = prods.map(p => `<option value="${p}">${p}</option>`).join('');
    };

    window.renderList = () => {
        const q = document.getElementById('search').value.toLowerCase();
        let h = "";
        window.allProducts?.filter(p => p.product.toLowerCase().includes(q)).forEach(p => {
            h += `<div class="card">
                <div>
                    <div style="font-weight:700; font-size:15px;">${p.product}</div>
                    <div style="font-size:12px; color:#64748b;">${p.bizName}</div>
                    ${window.isAdmin ? `<span class="admin-del" onclick="deleteItem('productos','${p.id}')">BORRAR REGISTRO</span>` : ''}
                </div>
                <div class="price-tag">$${p.price}</div>
            </div>`;
        });
        document.getElementById('items').innerHTML = h;
    };

    window.renderMarkers = () => {
        map.eachLayer(l => { if(l instanceof L.Marker && l !== window.uMk) map.removeLayer(l); });
        window.allBusinesses?.forEach(b => {
            const p = `<div style="padding:5px;"><b>${b.name}</b>${window.isAdmin ? `<br><span class="admin-del" onclick="deleteItem('negocios','${b.id}')">BORRAR LOCAL</span>` : ''}</div>`;
            L.marker([b.lat, b.lng], {icon: sIcon}).addTo(map).bindPopup(p);
        });
    };
</script>
</body>
</html>
