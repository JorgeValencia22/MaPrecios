<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaPrecios</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --brand: #0052ff; --dark: #0f172a; --radius: 25px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: #f8fafc; color: var(--dark); height: 100vh; overflow: hidden; width: 100%; position: fixed; }

        header { height: 70px; background: #fff; border-bottom: 1px solid #edf2f7; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; position: fixed; width: 100%; top: 0; z-index: 4000; }
        .logo { font-size: 24px; font-weight: 900; color: var(--brand); }

        main { height: 100vh; padding: 70px 0 80px 0; }
        .screen { display: none; height: 100%; width: 100%; padding: 20px; overflow-y: auto; }
        .screen.active { display: block; }

        /* MAPA */
        #sc-map { padding: 20px; }
        .map-container { height: 100%; width: 100%; background: #fff; border-radius: var(--radius); padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; border: 1px solid #eee; }
        #map { height: 100%; width: 100%; border-radius: 20px; }

        /* FORMULARIOS */
        .card { background: #fff; padding: 25px; border-radius: var(--radius); border: 1px solid #eee; margin-bottom: 20px; }
        .input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 15px; }
        .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--brand); color: white; font-weight: 800; cursor: pointer; }

        /* VOTOS Y VALIDACION */
        .vote-tag { font-size: 11px; font-weight: 900; background: #f1f5f9; padding: 4px 10px; border-radius: 50px; color: var(--brand); }

        /* NAVEGACION */
        nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: #fff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #edf2f7; z-index: 5000; }
        .nav-link { text-decoration: none; color: #94a3b8; font-size: 11px; font-weight: 900; }
        .nav-link.active { color: var(--brand); }

        /* PANEL ADMIN */
        .admin-panel { background: #0f172a; color: #fff; padding: 15px; border-radius: 15px; margin-top: 10px; font-size: 12px; border-left: 5px solid var(--brand); }
    </style>
</head>
<body>

    <header>
        <div class="logo">MaPrecios</div>
        <div id="auth-box">
            <div id="g_id_onload" data-client_id="741318611947-h590d5p7s9njemslu7th8g38v09i210a.apps.googleusercontent.com" data-callback="onAuth"></div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>
    </header>

    <main>
        <section id="sc-map" class="screen active">
            <div class="map-container">
                <div id="map"></div>
                <div id="pop-store" style="display:none; position:absolute; bottom:20px; left:20px; z-index:1000; background:#fff; padding:20px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); width:280px;">
                    <p style="font-weight:900; margin-bottom:10px;">Nuevo Negocio</p>
                    <input type="text" id="new-st-name" class="input" placeholder="Nombre comercial">
                    <button class="btn-main" onclick="App.addStore()">Registrar Ubicación</button>
                    <button style="width:100%; background:none; border:none; color:red; margin-top:10px; font-size:12px; cursor:pointer;" onclick="document.getElementById('pop-store').style.display='none'">Cancelar</button>
                </div>
            </div>
            <div id="adm-st" class="admin-panel" style="display:none;"></div>
        </section>

        <section id="sc-radar" class="screen">
            <div id="product-list" style="max-width:600px; margin:0 auto;"></div>
        </section>

        <section id="sc-add" class="screen">
            <div class="card" style="max-width:500px; margin:0 auto;">
                <h3 style="margin-bottom:20px;">Vincular Producto</h3>
                <label style="font-size:12px; font-weight:800; color:gray;">Selecciona Negocio Confirmado:</label>
                <select id="select-store" class="input" style="margin-top:5px;"></select>
                <input type="text" id="prod-name" class="input" placeholder="Nombre del producto">
                <input type="number" id="prod-price" class="input" placeholder="Precio actual ($)">
                <button class="btn-main" onclick="App.addPrice()">Publicar Precio</button>
            </div>
            <div id="adm-pr" class="admin-panel" style="display:none; max-width:500px; margin:20px auto;"></div>
        </section>

        <section id="sc-elite" class="screen">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; max-width:900px; margin:0 auto;">
                <div class="card" style="text-align:center;">
                    <h3>7 DÍAS ELITE</h3>
                    <form action="https://www.paypal.com/ncp/payment/9MB6JL9TDSVAL" method="post" target="_blank" style="margin-top:15px;">
                        <input type="submit" value="Pagar ahora" style="background:#FFD140; border:none; padding:12px 30px; border-radius:5px; font-weight:bold; cursor:pointer;">
                    </form>
                </div>
                <div class="card" style="text-align:center;">
                    <h3>1 MES ELITE</h3>
                    <form action="https://www.paypal.com/ncp/payment/GVP5ZED2Q2RLJ" method="post" target="_blank" style="margin-top:15px;">
                        <input type="submit" value="Pagar ahora" style="background:#FFD140; border:none; padding:12px 30px; border-radius:5px; font-weight:bold; cursor:pointer;">
                    </form>
                </div>
            </div>
        </section>
    </main>

    <nav>
        <a href="#" class="nav-link active" onclick="App.nav('sc-map', this)">MAPA</a>
        <a href="#" class="nav-link" onclick="App.nav('sc-radar', this)">RADAR</a>
        <a href="#" class="nav-link" onclick="App.nav('sc-add', this)">SUBIR</a>
        <a href="#" class="nav-link" onclick="App.nav('sc-elite', this)">ELITE</a>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fbc = {
            apiKey: "AIzaSyAzNx7ARReSFqDt052rIficuErmuq10WMc",
            authDomain: "studio-2946557679-4235d.firebaseapp.com",
            projectId: "studio-2946557679-4235d",
            storageBucket: "studio-2946557679-4235d.firebasestorage.app",
            appId: "1:1014571657099:web:f1bb8b8619c2474c95718e"
        };

        const db = getFirestore(initializeApp(fbc));
        const MY_MAIL = "jorge.valencia.abarca@gmail.com";

        window.App = {
            user: null, map: null, tempPos: null, stores: [], prices: [], markers: [],

            init: () => {
                App.map = L.map('map', { zoomControl: false }).setView([-33.4474, -70.6736], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_all/{z}/{x}/{y}{r}.png').addTo(App.map);
                
                App.map.on('click', e => {
                    if(!App.user) return alert("Inicia sesión para agregar un negocio.");
                    App.tempPos = e.latlng;
                    document.getElementById('pop-store').style.display = 'block';
                });

                onSnapshot(collection(db, "negocios"), s => {
                    App.stores = s.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderMap();
                    App.syncAdmin();
                });

                onSnapshot(collection(db, "productos"), s => {
                    App.prices = s.docs.map(d => ({id: d.id, ...d.data()}));
                    App.renderRadar();
                    App.syncAdmin();
                });
            },

            nav: (id, el) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                el.classList.add('active');
                if(id === 'sc-map') setTimeout(() => App.map.invalidateSize(), 200);
            },

            addStore: async () => {
                const n = document.getElementById('new-st-name').value;
                if(!n || !App.tempPos) return;
                await addDoc(collection(db, "negocios"), { name: n, lat: App.tempPos.lat, lng: App.tempPos.lng, votes: 1, confirmed: false });
                document.getElementById('pop-store').style.display = 'none';
                document.getElementById('new-st-name').value = "";
                alert("Negocio registrado. Se verá en el mapa tras 5 confirmaciones.");
            },

            addPrice: async () => {
                const sid = document.getElementById('select-store').value;
                const p = document.getElementById('prod-name').value;
                const v = document.getElementById('prod-price').value;
                if(!sid || !p || !v) return;
                await addDoc(collection(db, "productos"), { sid, prod: p, val: parseFloat(v), votes: 1, confirmed: false });
                document.getElementById('prod-name').value = "";
                document.getElementById('prod-price').value = "";
                alert("Precio enviado a validación.");
            },

            renderMap: () => {
                App.markers.forEach(m => App.map.removeLayer(m));
                App.stores.filter(s => s.confirmed).forEach(s => {
                    const m = L.circleMarker([s.lat, s.lng], { radius: 10, color: '#0052ff', fillOpacity: 1 }).addTo(App.map).bindPopup(`<b>${s.name}</b>`);
                    App.markers.push(m);
                });
                document.getElementById('select-store').innerHTML = App.stores.filter(s => s.confirmed).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            },

            renderRadar: () => {
                const feed = document.getElementById('product-list');
                feed.innerHTML = App.prices.filter(p => p.confirmed).map(p => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><small>Producto:</small><br><b>${p.prod}</b></div>
                        <div style="color:green; font-weight:900; font-size:20px;">$${p.val}</div>
                    </div>
                `).join('');
            },

            syncAdmin: () => {
                if(!App.user || App.user.email !== MY_MAIL) return;
                const stPanel = document.getElementById('adm-st');
                const prPanel = document.getElementById('adm-pr');
                stPanel.style.display = 'block'; prPanel.style.display = 'block';

                stPanel.innerHTML = "<b>Panel Negocios:</b><br>" + App.stores.map(s => `
                    ${s.name} (${s.votes}v) <button onclick="App.del('negocios','${s.id}')">Eliminar</button><br>
                `).join('');

                prPanel.innerHTML = "<b>Panel Productos:</b><br>" + App.prices.map(p => `
                    ${p.prod}: $${p.val} <button onclick="App.del('productos','${p.id}')">Eliminar</button><br>
                `).join('');
            },

            del: async (t, id) => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, t, id)); }
        };

        window.onAuth = (r) => {
            const u = JSON.parse(atob(r.credential.split('.')[1]));
            App.user = u;
            document.getElementById('auth-box').innerHTML = `<img src="${u.picture}" style="width:35px; border-radius:50%; border:2px solid var(--brand);">`;
            App.syncAdmin();
        };

        App.init();
    </script>
</body>
</html>
